/*! jQuery imgViewer - v0.7.3 - 2015-03-12
* https://github.com/waynegm/imgViewer
* Copyright (c) 2015 Wayne Mogg; Licensed MIT */
!function(a,b){var c,d="drag",e={distance:40};b.track(d,{touchstart:function(a,b,e){c=!1,b[d]={finger:e.point.length,start:e,deltaX:0,deltaY:0}},touchmove:function(f,g,h){var i=a.extend(e,f.data);g[d].finger=h.point.length>g[d].finger?h.point.length:g[d].finger;var j=b.calc.getDistance(g.start.point[0],h.point[0]);Math.abs(1-j)>i.distance&&(c||(a(f.target).trigger(a.Event("dragstart",g[d])),c=!0),g[d].deltaX=h.point[0].x-g.start.point[0].x,g[d].deltaY=h.point[0].y-g.start.point[0].y,a(f.target).trigger(a.Event("drag",g[d])))},touchend:function(f,g,h){if(c){c=!1;var i=b.calc.getDistance(g.start.point[0],h.point[0]);i>e.distance&&(g[d].deltaX=h.point[0].x-g.start.point[0].x,g[d].deltaY=h.point[0].y-g.start.point[0].y,a(f.target).trigger(a.Event("dragend",g[d])))}}})}(jQuery,jQuery.toe,this),function(a){a.widget("wgm.imgViewer",{options:{zoomStep:.1,zoom:1,zoomable:!0,onClick:null,onUpdate:null},_create:function(){function b(){f.render||(f.render=!0,d())}function c(){f.render=!1}function d(){f.render&&(window.requestAnimationFrame(d),f.update())}function e(a){if(f.options.zoomable){a.preventDefault();var b=a.deltaY;f.options.zoom-=b*f.options.zoomStep,f.update()}}var f=this;this.element.is("img")||a.error("imgviewer plugin can only be applied to img elements"),f.img=f.element[0];var g=a(f.img);f.zimg=a("<img/>",{src:f.img.src}).appendTo("body").wrap("<div id='img-viewport'  class='viewport'/>");var h=a(f.zimg);f.view=a(f.zimg).parent();var i=a(f.view);f.vCenter={},f.dragging=!1,f.ready=!1,g.one("load",function(){f.ready=!0;var a=g.width(),b=g.height(),c=g.offset();f.offsetPadding={top:parseInt(g.css("padding-top"),10),left:parseInt(g.css("padding-left"),10),right:parseInt(g.css("padding-right"),10),bottom:parseInt(g.css("padding-bottom"),10)},f.offsetBorder={x:Math.round((g.outerWidth()-g.innerWidth())/2),y:Math.round((g.outerHeight()-g.innerHeight())/2)};var d=c.top+f.offsetBorder.y+f.offsetPadding.top,e=c.left+f.offsetBorder.x+f.offsetPadding.left;i.css({position:"absolute",overflow:"hidden",top:d+"px",left:e+"px",width:a+"px",height:b+"px"}),h.css({position:"relative",top:"0px",left:"0px",width:a+"px",height:b+"px","-webkit-tap-highlight-color":"transparent"}),f.vCenter={x:a/2,y:b/2},f.update()}).each(function(){this.complete&&a(this).load()}),f.render=!1,h.on("mousewheel",e),window.navigator.msPointerEnabled?(h.on("click",function(a){a.preventDefault(),f.dragging||f._trigger("onClick",a,f)}),h.on("mousedown",function(d){function e(b){setTimeout(function(){f.dragging=!1},0),b.preventDefault(),c(),h.off("mousemove"),h.off("mouseup"),a(document).off("mouseup")}if(f.options.zoomable){a(document).one("mouseup",e),h.one("mouseup",e),d.preventDefault(),b();var g=d;h.on("mousemove",function(a){a.preventDefault(),f.dragging=!0,f.vCenter.x=f.vCenter.x-(a.pageX-g.pageX)/f.options.zoom,f.vCenter.y=f.vCenter.y-(a.pageY-g.pageY)/f.options.zoom,g=a})}})):(h.on("touchstart touchmove touchend",function(a){a.preventDefault()}),h.on("transformstart",function(a){f.options.zoomable&&(a.preventDefault(),f.pinchzoom=f.options.zoom,b())}),h.on("transform",function(a){f.options.zoomable&&(a.preventDefault(),f.options.zoom=f.pinchzoom*a.scale)}),h.on("transformend",function(a){f.options.zoomable&&(a.preventDefault(),f.options.zoom=f.pinchzoom*a.scale,c(),f.update())}),h.on("dragstart",function(a){f.options.zoomable&&(a.preventDefault(),f.dragging=!0,f.dragXorg=f.vCenter.x,f.dragYorg=f.vCenter.y,b())}),h.on("drag",function(a){f.options.zoomable&&(a.preventDefault(),f.vCenter.x=f.dragXorg-a.deltaX/f.options.zoom,f.vCenter.y=f.dragYorg-a.deltaY/f.options.zoom)}),h.on("dragend",function(a){f.options.zoomable&&(a.preventDefault(),f.dragging=!1,f.vCenter.x=f.dragXorg-a.deltaX/f.options.zoom,f.vCenter.y=f.dragYorg-a.deltaY/f.options.zoom,c(),f.update())}),void 0!==a.mobile?h.on("vclick",function(a){a.preventDefault(),f.dragging||f._trigger("onClick",a,f)}):h.on("tap click",function(a){a.preventDefault(),f.dragging||f._trigger("onClick",a,f)}),h.on("mousedown",function(d){function e(b){setTimeout(function(){f.dragging=!1},0),b.preventDefault(),c(),h.off("mousemove"),h.off("mouseup"),a(document).off("mouseup")}if(f.options.zoomable){d.preventDefault(),b();var g=d;h.on("mousemove",function(a){a.preventDefault(),f.dragging=!0,f.vCenter.x=f.vCenter.x-(a.pageX-g.pageX)/f.options.zoom,f.vCenter.y=f.vCenter.y-(a.pageY-g.pageY)/f.options.zoom,g=a}),a(document).one("mouseup",e),h.one("mouseup",e)}})),a(window).resize(function(){f.ready&&(f.vCenter.x*=g.width()/i.width(),f.vCenter.y*=g.height()/i.height(),f.update())})},destroy:function(){var b=a(this.zimg);b.unbind("click"),a(window).unbind("resize"),b.remove(),a(this.view).remove(),a.Widget.prototype.destroy.call(this)},_setOption:function(b,c){switch(b){case"zoom":if(parseFloat(c)<1||isNaN(parseFloat(c)))return;break;case"zoomStep":if(parseFloat(c)<=0||isNaN(parseFloat(c)))return}var d=a.ui.version.split(".");switch(d[0]>1||d[1]>8?this._super(b,c):a.Widget.prototype._setOption.apply(this,arguments),b){case"zoom":this.ready&&this.update()}},addElem:function(b){a(this.view).append(b)},isVisible:function(a,b){var c=this.getView();return c?a>=c.left&&a<=c.right&&b>=c.top&&b<=c.bottom:!1},getView:function(){if(this.ready){var b=a(this.img),c=b.width(),d=b.height(),e=this.options.zoom;return{top:this.vCenter.y/d-.5/e,left:this.vCenter.x/c-.5/e,bottom:this.vCenter.y/d+.5/e,right:this.vCenter.x/c+.5/e}}return null},panTo:function(b,c){if(this.ready&&b>=0&&1>=b&&c>=0&&1>=c){var d=a(this.img),e=d.width(),f=d.height();return this.vCenter.x=b*e,this.vCenter.y=c*f,this.update(),{x:this.vCenter.x/e,y:this.vCenter.y/f}}return null},imgToView:function(b,c){if(this.ready&&b>=0&&1>=b&&c>=0&&1>=c){var d=a(this.img),e=d.width(),f=d.height(),g=e/2-this.vCenter.x*this.options.zoom,h=f/2-this.vCenter.y*this.options.zoom,i=b*e*this.options.zoom+g,j=c*f*this.options.zoom+h;return{x:Math.round(i),y:Math.round(j)}}return null},imgToCursor:function(b,c){var d=this.imgToView(b,c);if(d){var e=a(this.img).offset();return d.x+=e.left+this.offsetBorder.x+this.offsetPadding.left,d.y+=e.top+this.offsetBorder.y+this.offsetPadding.top,d}return null},viewToImg:function(b,c){if(this.ready){var d=a(this.img),e=d.width(),f=d.height(),g=e/2-this.vCenter.x*this.options.zoom,h=f/2-this.vCenter.y*this.options.zoom,i=(b-g)/(e*this.options.zoom),j=(c-h)/(f*this.options.zoom);return i>=0&&1>=i&&j>=0&&1>=j?{x:i,y:j}:null}return null},cursorToImg:function(b,c){if(this.ready){var d=a(this.img),e=d.width(),f=d.height(),g=d.offset(),h=e/2-this.vCenter.x*this.options.zoom,i=f/2-this.vCenter.y*this.options.zoom,j=(b-g.left-this.offsetBorder.x-this.offsetPadding.left-h)/(e*this.options.zoom),k=(c-g.top-this.offsetBorder.y-this.offsetPadding.top-i)/(f*this.options.zoom);return j>=0&&1>=j&&k>=0&&1>=k?{x:j,y:k}:null}return null},update:function(){if(this.ready){var b,c,d,e,f=a(this.img),g=f.width(),h=f.height(),i=f.offset(),j=this.options.zoom,k=g/2,l=h/2;1>=j?(b=0,c=0,d=g,e=h,this.vCenter={x:k,y:l},this.options.zoom=1,j=1):(b=Math.round(l-this.vCenter.y*j),c=Math.round(k-this.vCenter.x*j),d=Math.round(g*j),e=Math.round(h*j),c>0?(this.vCenter.x=k/j,c=0):g>c+d&&(this.vCenter.x=g-k/j,c=g-d),b>0?(this.vCenter.y=l/j,b=0):h>b+e&&(this.vCenter.y=h-l/j,b=h-e));var m=Math.round(i.top+this.offsetBorder.y+this.offsetPadding.top),n=Math.round(i.left+this.offsetBorder.x+this.offsetPadding.left);a(this.view).css({top:m+"px",left:n+"px",width:g+"px",height:h+"px"}),a(this.zimg).css({width:g+"px",height:h+"px"});var o=-(this.vCenter.x-k)*j,p=-(this.vCenter.y-l)*j;a(this.zimg).css({transform:"translate("+o+"px,"+p+"px) scale("+j+","+j+")"}),this._trigger("onUpdate",null,this)}}})}(jQuery);